---
title: "Statistical power of piecewise-regression analyses in single-case experiments addressing behaviour problems"
author: "JÃ¼rgen Wilbert"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

```{r setup, include = FALSE}
library(scan)
library(scplot)
library(tidyverse)

source("plot_mc_function.R")
source("plm_mc_function.R")
source("mc_function.R")

knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)

create_mc <- function(filename, design, iterations, force_renew = FALSE) {
  if (file.exists(filename) && !force_renew) {
    out <- readRDS(filename)
  } else {
    out <- mc_scan(
      iterations = iterations,
      design = design,
      method = list(plm_level = plm_mc),
      alpha_test = FALSE
    )
    saveRDS(out, filename)
  }
  out
}

cat_parameters <- function(iterations, design) {
  cat("**Iterations:**  \n")
  cat(paste(names(iterations), "=", iterations, collapse = "  \n"), "  \n")
  cat("**Design:**  \n")
  cat(paste(names(design), "=", design, collapse = "  \n"), "  \n")
}

```


# Bascic reference case

The base design is:  

```{r results='asis'}

base_design <- design_template(
  n = n_sims,
  start_value = 15,
  level = 15 * -0.50,
  trend = rnorm(n_sims, 0, 0.2 * 15 /30),
  slope = rnorm(n_sims, 0, 0.2 * abs(15 * -0.50) /20),
  phase.design = list(A = 10, B = 20),
  distribution = "poisson"
)

cat("n_sims = 10000  \n")
cat(paste(names(base_design), "=", base_design, collapse = "  \n"))

```

## Example single-cases with the base deisgn parameters

```{r}

set.seed(1234)

tmp_env <- new.env()
tmp_env$n_sims <- 3

design <- do.call(
  "design_rSC",
  lapply(base_design, function(x) eval(x, envir = tmp_env))
)
dat <- rSC(design)


scplot::scplot(dat) %>%
  set_ylabel("Behaviour frequency") %>%
  set_yaxis(limits = c(0,40)) %>%
  add_statline("trend", color = "red") %>%
  add_text(paste0("Trend = ", round(design$cases[[1]]$trend,2), "; slope = ",
           round(design$cases[[1]]$slope[2], 2)), 1, 1, 2, hjust = 0) %>%
  add_text(paste0("Trend = ", round(design$cases[[2]]$trend,2), "; slope = ",
           round(design$cases[[2]]$slope[2], 2)), 2, 1, 2, hjust = 0) %>%
  add_text(paste0("Trend = ", round(design$cases[[3]]$trend,2), "; slope = ",
           round(design$cases[[3]]$slope[2], 2)), 3, 1, 2, hjust = 0)

```

```{r}
export(plm(dat[1], family = "poisson"))
export(plm(dat[2], family = "poisson"))
export(plm(dat[3], family = "poisson"))
```


# Length if A and B phase and intervention effectiveness 


```{r}
design <- modifyList(
  base_design,
  design_template(
    level = 15*level_effect,
    trend = rnorm(n_sims, 0, 0.2*15/(A_length+B_length)),
    slope = rnorm(n_sims, 0, 0.25*abs((15*level_effect))/B_length),
    phase.design = list(A = A_length, B = B_length)
  )
)

iterations <- list(
  A_length = seq(3, 20, by = 2),
  B_length = c(10, 15, 20, 30, 40, 50),
  level_effect = c(-0.2, -0.4, -0.6, -0.8),
  n_sims = 10000
)

out <- create_mc("phaselenght by leveleffect.rds", design, iterations)

plot_mc(out, caption = FALSE)

```

```{r results='asis'}
cat_parameters(iterations, design)
```

# Problemintensity, intervention effectiveness, and measurements 

```{r}
design <- design_template(
    n = n_sims,
    start_value = problemintensity,
    level = problemintensity*level_effect,
    trend = rnorm(n_sims, 0, 0.2*problemintensity/length),
    slope = rnorm(n_sims, 0, 0.25*abs(problemintensity*level_effect)/(length * 2 /3)),
    phase.design = list(A = length / 3, B = length * 2 /3 ),
    distribution = "poisson"
)

iterations <- list(
  problemintensity = c(5, 10, 15, 20, 25, 30),
  length = c(15,21,27,33, 39, 45),
  level_effect = c(-0.2, -0.4, -0.6, -0.8),
  n_sims = 10000
)

out <- create_mc("problemintensity by start_value by mts.rds", 
                 design, iterations,
                 force_renew = FALSE)

plot_mc(out, caption = FALSE,
        var_x = "length",
        var_shape = "level_effect",
        var_facet = "problemintensity", ncol = 2)

```

```{r results='asis'}
cat_parameters(iterations, design)
```


# Strength of trend effect, problemintensity, and measurements

```{r}
design <- design_template(
    n = n_sims,
    start_value = problemintensity,
    level = problemintensity*-0.5,
    trend = rnorm(n_sims, 0, abs(trend_effect*problemintensity/length)),
    slope = rnorm(n_sims, 0, abs(0.25*problemintensity*-0.5/(length * 2 /3))),
    phase.design = list(A = length / 3, B = length * 2 /3 ),
    distribution = "poisson"
)

iterations <- list(
  problemintensity = c(5, 10, 15, 20, 25, 30),
  length = c(15,21,27,33, 39, 45),
  trend_effect = c(-0.2, -0.4, -0.6, -0.8),
  n_sims = 10000
)

out <- create_mc("trend_effect by problemintensity by mts.rds", 
                 design, iterations,
                 force_renew = FALSE)

plot_mc(out, caption = FALSE,
        var_x = "length",
        var_shape = "trend_effect",
        var_facet = "problemintensity", ncol = 2)

```

```{r results='asis'}
cat_parameters(iterations, design)
```

